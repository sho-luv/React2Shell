# Custom ModSecurity Rules for CVE-2025-55182 (React Server Components RCE)
# These rules detect common RSC exploit patterns

# Rule 999001: Block RSC Accept Header (case-insensitive)
SecRule REQUEST_HEADERS:Accept "@rx (?i)text/x-component" \
    "id:999001,\
    phase:1,\
    deny,\
    status:403,\
    log,\
    msg:'RSC Exploit - Suspicious Accept header detected',\
    tag:'CVE-2025-55182',\
    severity:'CRITICAL'"

# Rule 999002: Block RSC-Action header (case-insensitive)
SecRule REQUEST_HEADERS_NAMES "@rx (?i)^rsc-action$" \
    "id:999002,\
    phase:1,\
    deny,\
    status:403,\
    log,\
    msg:'RSC Exploit - RSC-Action header detected',\
    tag:'CVE-2025-55182',\
    severity:'CRITICAL'"

# Rule 999003: Block x-action header (case-insensitive)
SecRule REQUEST_HEADERS_NAMES "@rx (?i)^x-action$" \
    "id:999003,\
    phase:1,\
    deny,\
    status:403,\
    log,\
    msg:'RSC Exploit - x-action header detected',\
    tag:'CVE-2025-55182',\
    severity:'CRITICAL'"

# Rule 999004: Block prototype pollution patterns in body (case-insensitive)
SecRule REQUEST_BODY "@rx (?i)__proto__|constructor\s*\[\s*['\"]?prototype|Object\s*\.\s*prototype" \
    "id:999004,\
    phase:2,\
    deny,\
    status:403,\
    log,\
    msg:'RSC Exploit - Prototype pollution pattern detected',\
    tag:'CVE-2025-55182',\
    severity:'CRITICAL'"

# Rule 999005: Block React Flight payload markers
SecRule REQUEST_BODY "@rx \"\\\$@|\"\\\$B|\"\\\$Q|\"\\\$1:" \
    "id:999005,\
    phase:2,\
    deny,\
    status:403,\
    log,\
    msg:'RSC Exploit - React Flight payload detected',\
    tag:'CVE-2025-55182',\
    severity:'CRITICAL'"

# Rule 999006: Block common RCE command patterns (case-insensitive)
SecRule REQUEST_BODY "@rx (?i)/bin/sh|/bin/bash|cmd\.exe|powershell|child_process|execSync|spawnSync" \
    "id:999006,\
    phase:2,\
    deny,\
    status:403,\
    log,\
    msg:'RSC Exploit - Command injection pattern detected',\
    tag:'CVE-2025-55182',\
    severity:'CRITICAL'"

# Rule 999007: Block reverse shell patterns (case-insensitive)
SecRule REQUEST_BODY "@rx (?i)nc\s+-[el]|mkfifo|/dev/tcp/|bash\s+-i|python\s+-c.*socket|perl\s+-e.*socket" \
    "id:999007,\
    phase:2,\
    deny,\
    status:403,\
    log,\
    msg:'RSC Exploit - Reverse shell pattern detected',\
    tag:'CVE-2025-55182',\
    severity:'CRITICAL'"

# Rule 999008: Block Next-Action header (case-insensitive using header names)
SecRule REQUEST_HEADERS_NAMES "@rx (?i)^next-action$" \
    "id:999008,\
    phase:1,\
    deny,\
    status:403,\
    log,\
    msg:'RSC Exploit - Next-Action header detected',\
    tag:'CVE-2025-55182',\
    severity:'CRITICAL'"

# Rule 999009: Block getBuiltinModule pattern (ESM exploitation)
SecRule REQUEST_BODY "@rx getBuiltinModule|mainModule\.require" \
    "id:999009,\
    phase:2,\
    deny,\
    status:403,\
    log,\
    msg:'RSC Exploit - Node.js module access pattern detected',\
    tag:'CVE-2025-55182',\
    severity:'CRITICAL'"

# Rule 999010: Block resolved_model status (Flight protocol marker)
SecRule REQUEST_BODY "@rx resolved_model" \
    "id:999010,\
    phase:2,\
    deny,\
    status:403,\
    log,\
    msg:'RSC Exploit - Flight protocol resolved_model detected',\
    tag:'CVE-2025-55182',\
    severity:'CRITICAL'"

# ============================================
# BYPASS TESTING NOTES
# ============================================
# These rules can still potentially be bypassed using:
# 1. Junk data padding to exceed inspection limits (--waf-bypass)
# 2. Chunked transfer encoding
# 3. Unicode encoding of payload
# 4. Double URL encoding
# 5. Content-Type manipulation
# 6. HTTP/2 or HTTP/3 specific techniques
#
# Remember: WAF rules are defense-in-depth, not a substitute for patching!
