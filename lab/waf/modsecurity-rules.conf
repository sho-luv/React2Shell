# Custom ModSecurity Rules for CVE-2025-55182 (React Server Components RCE)
# These rules detect common RSC exploit patterns

# Rule 999001: Block RSC Accept Header
SecRule REQUEST_HEADERS:Accept "@contains text/x-component" \
    "id:999001,\
    phase:1,\
    deny,\
    status:403,\
    log,\
    msg:'RSC Exploit - Suspicious Accept header detected',\
    tag:'CVE-2025-55182',\
    severity:'CRITICAL'"

# Rule 999002: Block RSA Action header (can be bypassed with case variations)
SecRule REQUEST_HEADERS:RSC-Action "@rx ^.+$" \
    "id:999002,\
    phase:1,\
    deny,\
    status:403,\
    log,\
    msg:'RSC Exploit - RSC-Action header detected',\
    tag:'CVE-2025-55182',\
    severity:'CRITICAL'"

# Rule 999003: Block x-action header
SecRule REQUEST_HEADERS:x-action "@rx ^.+$" \
    "id:999003,\
    phase:1,\
    deny,\
    status:403,\
    log,\
    msg:'RSC Exploit - x-action header detected',\
    tag:'CVE-2025-55182',\
    severity:'CRITICAL'"

# Rule 999004: Block prototype pollution patterns in body
SecRule REQUEST_BODY "@rx __proto__|constructor\[.prototype\]|Object\.prototype" \
    "id:999004,\
    phase:2,\
    deny,\
    status:403,\
    log,\
    msg:'RSC Exploit - Prototype pollution pattern detected',\
    tag:'CVE-2025-55182',\
    severity:'CRITICAL'"

# Rule 999005: Block React Flight payload markers
SecRule REQUEST_BODY "@rx \x00[A-Z]:|@1\"|\"\\$@" \
    "id:999005,\
    phase:2,\
    deny,\
    status:403,\
    log,\
    msg:'RSC Exploit - React Flight payload detected',\
    tag:'CVE-2025-55182',\
    severity:'CRITICAL'"

# Rule 999006: Block common RCE command patterns
SecRule REQUEST_BODY "@rx /bin/sh|/bin/bash|cmd\.exe|powershell|exec\(|system\(|passthru\(|shell_exec\(" \
    "id:999006,\
    phase:2,\
    deny,\
    status:403,\
    log,\
    msg:'RSC Exploit - Command injection pattern detected',\
    tag:'CVE-2025-55182',\
    severity:'CRITICAL'"

# Rule 999007: Block reverse shell patterns
SecRule REQUEST_BODY "@rx nc\s+-[el]|mkfifo|/dev/tcp/|bash\s+-i" \
    "id:999007,\
    phase:2,\
    deny,\
    status:403,\
    log,\
    msg:'RSC Exploit - Reverse shell pattern detected',\
    tag:'CVE-2025-55182',\
    severity:'CRITICAL'"

# Rule 999008: Block Next-Action header (case-insensitive)
SecRule REQUEST_HEADERS:Next-Action "@rx ^.+$" \
    "id:999008,\
    phase:1,\
    deny,\
    status:403,\
    log,\
    msg:'RSC Exploit - Next-Action header detected',\
    tag:'CVE-2025-55182',\
    severity:'CRITICAL'"

# ============================================
# BYPASS TESTING RULES (weaker patterns)
# These demonstrate common WAF bypass techniques
# ============================================

# Note: Attackers may bypass using:
# 1. Case variations: next-ACTION, NEXT-action
# 2. Unicode encoding: %6E%65%78%74 = "next"
# 3. Double encoding: %256E = %6E = n
# 4. Junk data padding to exceed rule inspection limits
# 5. HTTP Parameter Pollution
# 6. Chunked transfer encoding
# 7. Content-Type manipulation
